<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Cherry-Pick Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1f2937;
            --border-primary: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --accent-primary: #58a6ff;
            --accent-success: #238636;
            --accent-success-hover: #2ea043;
            --accent-error: #da3633;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --border-primary: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #1f2328;
            --text-muted: #656d76;
            --accent-primary: #0969da;
            --accent-success: #1a7f37;
            --accent-success-hover: #2da44e;
            --accent-error: #cf222e;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            line-height: 1.6;
            transition: background 0.2s, color 0.2s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 8px 24px var(--shadow);
        }

        .login-card h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-card p {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-family: ui-monospace, monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            background: var(--accent-success);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-success-hover);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
        }

        .help-text {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .help-text a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        /* Loading Screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-primary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-muted);
        }

        /* Main Screen */
        .main-screen {
            display: none;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-primary);
            padding: 16px 0;
            z-index: 100;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .branch-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .branch-badge {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-family: ui-monospace, monospace;
            color: var(--accent-primary);
        }

        .selection-info {
            color: var(--text-muted);
            font-size: 14px;
        }

        .selection-info strong {
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 16px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent-success);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-success-hover);
        }

        .theme-switcher {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .theme-switcher:hover {
            background: var(--bg-tertiary);
        }

        /* Banner */
        .banner {
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .banner.show {
            display: flex;
        }

        .banner-success {
            background: var(--accent-success);
            border: 1px solid var(--accent-success-hover);
            color: white;
        }

        .banner-error {
            background: var(--accent-error);
            border: 1px solid var(--accent-error);
            color: white;
        }

        .banner-content {
            flex: 1;
        }

        .banner a {
            color: white;
            text-decoration: underline;
        }

        .banner-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 0 8px;
        }

        /* Controls */
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .filter-toggle input {
            cursor: pointer;
        }

        .merge-count {
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Commits */
        .commits-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .commit-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .commit-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .commit-card.selected {
            border-color: var(--accent-success);
            background: var(--bg-tertiary);
        }

        body.light-theme .commit-card.selected {
            background: #f0f9ff;
        }

        .commit-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .commit-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }

        .commit-info {
            flex: 1;
        }

        .commit-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .commit-description {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        .commit-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .commit-sha {
            font-family: ui-monospace, monospace;
            color: var(--accent-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h2 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }

            .btn-small {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1>GitHub Cherry-Pick Tool</h1>
            <p>Connect to Fulgerr/docs-pilot</p>
            
            <div class="form-group">
                <label for="tokenInput">GitHub Personal Access Token</label>
                <input 
                    type="password" 
                    id="tokenInput" 
                    placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                    autocomplete="off"
                >
            </div>

            <button class="btn" id="loginBtn" onclick="handleLogin()">Connect</button>

            <div class="help-text">
                Need a token? <a href="https://github.com/settings/tokens/new?scopes=repo&description=Cherry-Pick-Tool" target="_blank">Create one here</a> with <strong>repo</strong> scope.
            </div>

            <div id="loginError" style="margin-top: 16px; color: #f85149; display: none;"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Connecting...</div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="main-screen">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="branch-info">
                        <span class="branch-badge">develop</span>
                        <span>â†’</span>
                        <span class="branch-badge">main</span>
                        <span class="selection-info">
                            <strong id="selectedCount">0</strong> selected
                        </span>
                    </div>
                    <div class="header-actions">
                        <button class="theme-switcher" onclick="toggleTheme()" title="Toggle theme">
                            <span id="themeIcon">ðŸŒ™</span>
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="handleSignOut()">Sign Out</button>
                        <button class="btn btn-small btn-primary" id="createPrBtn" onclick="handleCreatePR()" disabled>Create PR</button>
                    </div>
                </div>
            </div>

            <!-- Banner -->
            <div id="successBanner" class="banner banner-success">
                <div class="banner-content" id="successBannerContent"></div>
                <button class="banner-close" onclick="closeBanner('successBanner')">Ã—</button>
            </div>

            <div id="errorBanner" class="banner banner-error">
                <div class="banner-content" id="errorBannerContent"></div>
                <button class="banner-close" onclick="closeBanner('errorBanner')">Ã—</button>
            </div>

            <!-- Controls -->
            <div class="controls">
                <input 
                    type="text" 
                    class="search-box" 
                    id="searchBox" 
                    placeholder="Search commits by message, author, or SHA..."
                    oninput="filterCommits()"
                >
                <label class="filter-toggle">
                    <input type="checkbox" id="hideMergeCommits" checked onchange="filterCommits()">
                    <span>Hide merge commits</span>
                    <span class="merge-count" id="mergeCount"></span>
                </label>
            </div>

            <!-- Commits -->
            <div id="commitsContainer" class="commits-container"></div>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'Fulgerr';
        const REPO_NAME = 'docs-pilot';
        const SOURCE_BRANCH = 'develop';
        const TARGET_BRANCH = 'main';
        const TOKEN_KEY = 'github_token';

        let token = null;
        let allCommits = [];
        let selectedCommits = new Set();

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const storedToken = localStorage.getItem(TOKEN_KEY);
            if (storedToken) {
                showLoading();
                await authenticate(storedToken);
            }
            
            // Load theme preference
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        }

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                themeIcon.textContent = 'ðŸŒ™';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-theme');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'light');
            }
        }

        // Authentication
        async function handleLogin() {
            const tokenInput = document.getElementById('tokenInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            const inputToken = tokenInput.value.trim();
            if (!inputToken) {
                showError('Please enter a token', 'loginError');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Connecting...';
            loginError.style.display = 'none';

            showLoading();
            await authenticate(inputToken);
        }

        async function authenticate(inputToken) {
            try {
                // Validate token by making a simple API call
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`, {
                    headers: {
                        'Authorization': `token ${inputToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(response.status === 401 ? 'Invalid token' : 'Repository access denied');
                }

                token = inputToken;
                localStorage.setItem(TOKEN_KEY, token);
                
                await loadCommits();
                showMainScreen();
            } catch (error) {
                console.error('Authentication error:', error);
                showError(error.message, 'loginError');
                hideLoading();
                resetLoginButton();
            }
        }

        function handleSignOut() {
            localStorage.removeItem(TOKEN_KEY);
            token = null;
            selectedCommits.clear();
            allCommits = [];
            showLoginScreen();
        }

        // UI State Management
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function resetLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Connect';
        }

        function showError(message, elementId = 'errorBannerContent') {
            if (elementId === 'loginError') {
                const errorEl = document.getElementById(elementId);
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else {
                document.getElementById(elementId).textContent = message;
                document.getElementById('errorBanner').classList.add('show');
            }
        }

        function showSuccess(html) {
            document.getElementById('successBannerContent').innerHTML = html;
            document.getElementById('successBanner').classList.add('show');
        }

        function closeBanner(id) {
            document.getElementById(id).classList.remove('show');
        }

        // GitHub API Calls
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`https://api.github.com${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `API call failed: ${response.status}`);
            }

            return response.json();
        }

        // Load Commits
        async function loadCommits() {
            try {
                closeBanner('errorBanner');

                // Get commits from both branches
                const [developCommits, mainCommits] = await Promise.all([
                    getCommits(SOURCE_BRANCH),
                    getCommits(TARGET_BRANCH)
                ]);

                // Create a set of tree SHAs from main to detect cherry-picked commits
                const mainTreeShas = new Set(mainCommits.map(c => c.commit.tree.sha));

                // Filter out commits that exist on main (by tree SHA comparison)
                allCommits = developCommits.filter(commit => {
                    return !mainTreeShas.has(commit.commit.tree.sha);
                });

                renderCommits();
            } catch (error) {
                console.error('Error loading commits:', error);
                showError(`Failed to load commits: ${error.message}`);
            }
        }

        async function getCommits(branch, page = 1, allResults = []) {
            const perPage = 100;
            const commits = await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/commits?sha=${branch}&per_page=${perPage}&page=${page}`);
            
            allResults.push(...commits);

            // If we got a full page, there might be more
            if (commits.length === perPage) {
                return getCommits(branch, page + 1, allResults);
            }

            return allResults;
        }

        // Render Commits
        function renderCommits() {
            const container = document.getElementById('commitsContainer');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const hideMerge = document.getElementById('hideMergeCommits').checked;

            let filteredCommits = allCommits;

            // Filter by search
            if (searchTerm) {
                filteredCommits = filteredCommits.filter(commit => {
                    const message = commit.commit.message.toLowerCase();
                    const author = commit.commit.author.name.toLowerCase();
                    const sha = commit.sha.toLowerCase();
                    return message.includes(searchTerm) || author.includes(searchTerm) || sha.includes(searchTerm);
                });
            }

            // Count merge commits
            const mergeCommits = filteredCommits.filter(c => c.parents && c.parents.length > 1);
            document.getElementById('mergeCount').textContent = mergeCommits.length > 0 ? `(${mergeCommits.length} merge commits)` : '';

            // Filter merge commits
            if (hideMerge) {
                filteredCommits = filteredCommits.filter(c => !c.parents || c.parents.length <= 1);
            }

            if (filteredCommits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No commits found</h2>
                        <p>All commits from develop are already on main, or your search didn't match any commits.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredCommits.map((commit, index) => {
                const messageParts = commit.commit.message.split('\n');
                const title = messageParts[0];
                const description = messageParts.slice(1).join('\n').trim();
                const shortSha = commit.sha.substring(0, 7);
                const isSelected = selectedCommits.has(commit.sha);
                const date = new Date(commit.commit.author.date);
                const relativeDate = getRelativeTime(date);

                return `
                    <div class="commit-card ${isSelected ? 'selected' : ''}" 
                         data-sha="${commit.sha}"
                         onclick="toggleCommit('${commit.sha}')"
                         style="animation-delay: ${index * 0.05}s">
                        <div class="commit-card-header">
                            <input type="checkbox" 
                                   class="commit-checkbox" 
                                   ${isSelected ? 'checked' : ''}
                                   onclick="event.stopPropagation(); toggleCommit('${commit.sha}')">
                            <div class="commit-info">
                                <div class="commit-title">${escapeHtml(title)} #${shortSha}</div>
                                ${description ? `<div class="commit-description">${escapeHtml(description)}</div>` : ''}
                                <div class="commit-meta">
                                    <span>${escapeHtml(commit.commit.author.name)}</span>
                                    <span>${relativeDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterCommits() {
            renderCommits();
        }

        // Commit Selection
        function toggleCommit(sha) {
            if (selectedCommits.has(sha)) {
                selectedCommits.delete(sha);
            } else {
                selectedCommits.add(sha);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.getElementById('selectedCount').textContent = selectedCommits.size;
            document.getElementById('createPrBtn').disabled = selectedCommits.size === 0;
            
            // Update commit cards
            document.querySelectorAll('.commit-card').forEach(card => {
                const sha = card.dataset.sha;
                const checkbox = card.querySelector('.commit-checkbox');
                if (selectedCommits.has(sha)) {
                    card.classList.add('selected');
                    checkbox.checked = true;
                } else {
                    card.classList.remove('selected');
                    checkbox.checked = false;
                }
            });
        }

        // Create PR
        async function handleCreatePR() {
            if (selectedCommits.size === 0) return;

            const createPrBtn = document.getElementById('createPrBtn');
            createPrBtn.disabled = true;
            createPrBtn.textContent = 'Creating PR...';
            closeBanner('errorBanner');
            closeBanner('successBanner');

            try {
                // Get selected commit objects sorted by date (oldest first)
                const selectedCommitObjects = allCommits
                    .filter(c => selectedCommits.has(c.sha))
                    .sort((a, b) => new Date(a.commit.author.date) - new Date(b.commit.author.date));

                // Create branch name
                const branchName = createBranchName(selectedCommitObjects);

                // Get current main HEAD
                const mainRef = await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/ref/heads/${TARGET_BRANCH}`);
                const mainSha = mainRef.object.sha;

                // Create new branch
                await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/refs`, {
                    method: 'POST',
                    body: JSON.stringify({
                        ref: `refs/heads/${branchName}`,
                        sha: mainSha
                    })
                });

                // Cherry-pick commits
                let currentSha = mainSha;
                for (const commit of selectedCommitObjects) {
                    currentSha = await cherryPickCommit(commit.sha, currentSha, branchName);
                }

                // Create PR
                const pr = await createPullRequest(branchName, selectedCommitObjects);

                showSuccess(`Pull request created successfully! <a href="${pr.html_url}" target="_blank">View PR #${pr.number}</a>`);
                
                // Clear selection and reload commits
                selectedCommits.clear();
                updateSelectionUI();
                await loadCommits();

            } catch (error) {
                console.error('Error creating PR:', error);
                showError(`Failed to create PR: ${error.message}`);
            } finally {
                createPrBtn.disabled = false;
                createPrBtn.textContent = 'Create PR';
            }
        }

        function createBranchName(commits) {
            const firstCommitTitle = commits[0].commit.message.split('\n')[0];
            
            // Sanitize: lowercase, keep alphanumeric and slashes, replace others with dashes
            let sanitized = firstCommitTitle
                .toLowerCase()
                .replace(/[^a-z0-9\/]+/g, '-')
                .replace(/^-+|-+$/g, '');

            if (commits.length === 1) {
                return `release/${sanitized}`;
            } else {
                return `release/${sanitized}-plus-${commits.length - 1}-more`;
            }
        }

        async function cherryPickCommit(commitSha, parentSha, branchName) {
            // Get the commit details
            const commit = await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/commits/${commitSha}`);
            
            // Get parent tree
            const parentCommit = await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/commits/${parentSha}`);
            
            // Create merge commit (this will handle conflicts by creating the commit anyway)
            try {
                const newCommit = await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/commits`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: commit.message,
                        tree: commit.tree.sha,
                        parents: [parentSha]
                    })
                });

                // Update branch reference
                await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/git/refs/heads/${branchName}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        sha: newCommit.sha
                    })
                });

                return newCommit.sha;
            } catch (error) {
                // If there's a conflict, the tree SHA won't match - but PR will still be created
                // and GitHub will show the conflict
                throw error;
            }
        }

        async function createPullRequest(branchName, commits) {
            let title, body;

            if (commits.length === 1) {
                const commit = commits[0];
                const messageParts = commit.commit.message.split('\n');
                title = messageParts[0];
                const description = messageParts.slice(1).join('\n').trim();

                body = `Cherry-picking commit [${commit.sha.substring(0, 7)}](https://github.com/${REPO_OWNER}/${REPO_NAME}/commit/${commit.sha})\n\n`;
                
                if (description) {
                    body += `${description}\n\n`;
                }

                body += `---\n*Created with Cherry-Pick Tool*`;
            } else {
                const firstCommit = commits[0];
                title = `${firstCommit.commit.message.split('\n')[0]} (+${commits.length - 1} more commits)`;

                body = `Cherry-picking ${commits.length} commits:\n\n`;

                commits.forEach(commit => {
                    const messageParts = commit.commit.message.split('\n');
                    const commitTitle = messageParts[0];
                    const description = messageParts.slice(1).join('\n').trim();

                    body += `### [${commit.sha.substring(0, 7)}](https://github.com/${REPO_OWNER}/${REPO_NAME}/commit/${commit.sha}) ${commitTitle}\n\n`;
                    
                    if (description) {
                        body += `${description}\n\n`;
                    }
                });

                body += `---\n*Created with Cherry-Pick Tool*`;
            }

            body += `\n\n> **Note:** If there are conflicts, please resolve them in GitHub's web interface before merging.`;

            return await apiCall(`/repos/${REPO_OWNER}/${REPO_NAME}/pulls`, {
                method: 'POST',
                body: JSON.stringify({
                    title: title,
                    body: body,
                    head: branchName,
                    base: TARGET_BRANCH
                })
            });
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSecs < 60) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 30) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>